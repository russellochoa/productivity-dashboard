<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bank - The Dice Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        @keyframes roll {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.2); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        .dice-animation {
            animation: roll 0.6s ease-in-out;
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .player-active {
            position: relative;
            z-index: 10;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.15);
        }
        .player-active::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 10px;
            background: linear-gradient(60deg, #eef2ff, #dbeafe, #c7d2fe, #dbeafe, #eef2ff);
            background-size: 300% 300%;
            animation: gradient-animation 8s ease infinite;
            z-index: -1;
        }

        .player-winner { background-color: #dcfce7; }
        .player-winner .player-name { color: #166534; font-weight: 700; }
        .player-banked { opacity: 0.6; background-color: #f3f4f6; }
        #players-container::-webkit-scrollbar { display: none; }
        #players-container { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { background-color: white; color: #4f46e5; }
        
        @keyframes red-flash-anim {
            0% { opacity: 0.5; }
            100% { opacity: 0; }
        }
        #red-flash {
            position: fixed;
            inset: 0;
            background: red;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .animated-gradient-text {
            background: linear-gradient(60deg, #6366f1, #a855f7, #6366f1);
            background-size: 200% 200%;
            animation: gradient-animation 3s ease infinite;
        }

        .btn-gradient-blue {
            background-image: linear-gradient(to right, #4f46e5 0%, #818cf8 51%, #4f46e5 100%);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .btn-gradient-blue:hover {
            background-position: right center;
        }
        .btn-gradient-green {
            background-image: linear-gradient(to right, #10b981 0%, #34d399 51%, #10b981 100%);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .btn-gradient-green:hover {
            background-position: right center;
        }
        .how-built-tab {
            border-color: transparent;
            border-bottom-color: #d1d5db;
        }
        .how-built-tab-active {
            border-color: #d1d5db;
            border-bottom-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col p-2 sm:p-4">

    <main class="w-full max-w-5xl mx-auto flex flex-col md:flex-row gap-4 flex-grow min-h-0">
        
        <div id="players-container" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 content-start p-1">
            </div>

        <div class="flex-shrink-0 w-full md:w-72 lg:w-80 bg-slate-50 p-2 rounded-2xl shadow-lg flex flex-col justify-between">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center bg-slate-200 p-1 rounded-lg">
                    <button data-tab="electronic" class="tab tab-active w-1/2 py-1 rounded-md font-semibold transition-all">Digital Dice</button>
                    <button data-tab="atom" class="tab w-1/2 py-1 rounded-md font-semibold transition-all">Real Dice</button>
                </div>

                <div class="text-center my-4">
                    <h2 class="text-xs font-medium text-slate-500">CENTRAL BANK</h2>
                    <p id="central-bank-score" class="text-4xl font-bold text-indigo-600">0</p>
                    <div class="h-8 flex flex-col justify-center items-center">
                        <p id="round-counter" class="text-xs font-semibold text-slate-600">Round 0 / 0</p>
                        <p id="bonus-rolls-counter" class="hidden text-xs font-bold text-green-600">Bonus Rolls Left: 3</p>
                    </div>
                </div>
            </div>

            <div id="controls-container" class="flex-grow flex flex-col justify-center mb-2">
                <div id="electronic-controls" class="space-y-2">
                     <div class="flex justify-center items-center gap-4">
                        <div id="dice-container-1" class="w-14 h-14 flex items-center justify-center relative"></div>
                        <div id="dice-container-2" class="w-14 h-14 flex items-center justify-center relative"></div>
                    </div>
                    <button data-action="roll-dice" class="w-full text-white font-semibold py-2 px-4 rounded-lg shadow-md active:scale-95 btn-gradient-blue flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.5a9.5 9.5 0 1 0 9.5 9.5h-1a8.5 8.5 0 1 1-8.5-8.5v-1z"/><path d="M12 2.5a9.5 9.5 0 0 1 9.5 9.5h-1a8.5 8.5 0 0 0-8.5-8.5v-1z"/><path d="M12 12a1 1 0 1 0-1-1 1 1 0 0 0 1 1z"/></svg>
                        Roll Dice
                    </button>
                </div>
                <div id="atom-controls" class="hidden space-y-2">
                    <div id="atom-buttons-grid" class="grid grid-cols-4 gap-1"></div>
                </div>
            </div>
            
            <div class="w-full space-y-2 flex-shrink-0">
                <button data-action="bank-score" class="w-full text-white font-semibold py-2 px-4 rounded-lg shadow-md active:scale-95 btn-gradient-green flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h20M2 6h20M2 18h20M6 3v18M18 3v18"/></svg>
                    Bank Points
                </button>
                <hr class="w-full border-slate-300">
                <div class="w-full grid grid-cols-3 gap-2">
                    <button data-action="add-player" class="w-full text-white font-semibold py-2 px-4 rounded-lg shadow-md active:scale-95 btn-gradient-blue flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                    </button>
                    <button data-action="undo" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m16 8-6 6"/><path d="m16 14-6-6"/></svg>
                    </button>
                    <button data-action="new-game" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8m0 8a9 9 0 0 0 15 2.7l3-2.7"/><path d="M21 22v-6h-6"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div id="winner-modal-content" class="modal-content hidden bg-white rounded-2xl shadow-xl p-8 text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-4xl font-bold text-yellow-500 mb-2">Game Over!</h2>
            <p id="winner-message" class="text-2xl font-semibold text-slate-800 mb-6"></p>
            <div id="final-scores-list" class="mt-6 text-left max-h-48 overflow-y-auto"></div>
            <button data-action="play-again" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 active:scale-95 mt-6">Play Again</button>
        </div>
        <div id="edit-name-modal-content" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Edit Player Name</h2>
            <input type="text" id="edit-name-input" class="w-full border-2 border-slate-300 rounded-lg p-3 text-lg" placeholder="Enter new name">
            <div class="flex gap-3 mt-4">
                <button data-action="save-name" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Save</button>
                <button data-action="cancel-modal" class="w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-300">Cancel</button>
            </div>
        </div>
        <div id="rounds-modal-content" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0 relative">
            <div class="text-center mb-4">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text animated-gradient-text">Bank, the dice game</h1>
                <p class="text-xs text-slate-400 font-medium">by Russell Ochoa</p>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">How many rounds?</h2>
            <input type="number" id="rounds-input" class="w-full border-2 border-slate-300 rounded-lg p-3 text-lg text-center" value="10" min="1">
            <div class="flex gap-3 mt-4">
                <button data-action="start-game" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600">Start Game</button>
                <button data-action="show-rules" class="w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-300">Rules</button>
            </div>
            <button data-action="how-built" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            </button>
            <p class="absolute bottom-2 right-3 text-xs text-slate-300 font-mono">V10.0 | 16 Prompts</p>
        </div>
        <div id="banking-modal-content" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Who is Banking?</h2>
            <div id="banking-player-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-3 mt-4">
                <button data-action="confirm-bank" class="w-full bg-emerald-500 text-white font-semibold py-3 rounded-lg hover:bg-emerald-600">Confirm</button>
                <button data-action="cancel-modal" class="w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-300">Cancel</button>
            </div>
        </div>
        <div id="new-game-confirm-modal" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Start New Game?</h2>
            <p class="text-slate-600 mb-4">Your current game progress will be lost.</p>
            <div class="flex gap-3 mt-4">
                <button data-action="confirm-new-game" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600">Yes, Start New</button>
                <button data-action="cancel-modal" class="w-full bg-slate-200 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-300">Cancel</button>
            </div>
        </div>
        <div id="rules-modal-content" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0 text-left">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">Game Rules</h2>
            <ul class="space-y-2 text-slate-600 list-disc list-inside">
                <li><b>Objective:</b> Have the highest score after all rounds are complete.</li>
                <li><b>Gameplay:</b> Players take turns rolling. The sum of the dice is added to the Central Bank.</li>
                <li><b>Doubles:</b> Rolling doubles doubles the entire Central Bank score.</li>
                <li><b>Bonus Rolls:</b> The first 3 rolls of a round are safe. Rolling a 7 adds 70 points to the bank.</li>
                <li><b>Busting:</b> After the first 3 rolls, rolling a 7 ends the round. All points in the Central Bank are lost.</li>
                <li><b>Banking:</b> Any player can bank the current pot at any time. A menu will appear to select who is banking. Banked players are out for the rest of the round.</li>
            </ul>
            <div class="flex gap-3 mt-6">
                <button data-action="close-rules" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Got it!</button>
            </div>
        </div>
        <div id="how-built-modal" class="modal-content hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0 text-left flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0">
                <div class="flex border-b border-slate-200 mb-4">
                    <button data-tab-target="overview" class="how-built-tab how-built-tab-active font-semibold text-slate-700 py-2 px-4 border-b-2 -mb-px">Overview</button>
                    <button data-tab-target="log" class="how-built-tab font-semibold text-slate-500 py-2 px-4 border-b-2 -mb-px">Development Log</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <div id="overview" class="how-built-tab-content space-y-3 text-slate-600">
                    <p>This game wasn't built in a traditional code editor. It was crafted in a single, rapid-prototyping session through a conversation between a user (Russell) and an AI.</p>
                    <p>From a simple idea to a polished game, this project is a perfect example of how you can bring an idea to to life quickly just by collaborating and refining your vision with an AI.</p>
                    <h3 class="font-bold text-slate-700 pt-2">Here's a breakdown of the creative sprint:</h3>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><b class="font-semibold">Total Build Time:</b> Approximately 2.5 hours of active design and development.</li>
                        <li><b class="font-semibold">Development Method:</b> Conversational AI-driven development.</li>
                        <li><b class="font-semibold">Total Prompts:</b> 16 iterative requests that took the game from a basic concept to a fully-featured product.</li>
                        <li><b class="font-semibold">Lines of Code:</b> Over 500 lines of HTML, CSS, and vanilla JavaScript.</li>
                        <li><b class="font-semibold">Core Technologies:</b> Vanilla JavaScript, Tailwind CSS, and a lot of creative feedback!</li>
                    </ul>
                </div>
                <div id="log" class="how-built-tab-content hidden space-y-2 text-slate-600 text-sm">
                    <h3 class="font-bold text-slate-700 text-base">Development Log</h3>
                    <p class="text-xs italic">This log shows the step-by-step feature requests that shaped the game.</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><b>Initial Request:</b> Create the dice game "Bank" and allow for adding multiple players.</li>
                        <li><b>Mobile Optimization:</b> Make the layout mobile-friendly for Chrome browsers.</li>
                        <li><b>Rule Change & UI:</b> Change to two dice, with 7 as a bust. Add the ability to edit and remove players. Redesign the layout to fit everything on a single mobile screen without scrolling.</li>
                        <li><b>Dynamic Layout:</b> Make the player cards dynamic, resizing and arranging into columns as more players are added to save space.</li>
                        <li><b>Layout Fix:</b> Correct the layout to ensure the player area scrolls independently and the controls are always visible at the bottom.</li>
                        <li><b>Advanced Dynamic Layout:</b> Improve the dynamic layout to handle up to 8 players by making cards progressively smaller.</li>
                        <li><b>Layout Simplification:</b> Abandon the dynamic layout in favor of a fixed two-column grid that can fit 8 players without scrolling, only scrolling for players 9 and 10.</li>
                        <li><b>Major Rule Overhaul:</b> Introduce two modes: "Electronic" (simulated dice) and "Atom" (manual input for real dice). Change the game to be round-based. Implement a central bank pot. Add a "doubles" rule that doubles the pot.</li>
                        <li><b>Bug Fix:</b> Resolve a TypeError that was preventing the game from running.</li>
                        <li><b>"Atoms" Mode UI Upgrade:</b> Replace manual input with one-tap buttons for all possible dice rolls. Create a separate, distinct section for "doubles" rolls. Reorganize buttons numerically and add dice icons.</li>
                        <li><b>New Rules & Bug Fixes:</b> Add a "first 3 rolls" grace period where rolling a 7 adds 70 points. Fix a bug preventing the game from starting correctly. Increase the size of dice icons in the "Atoms" buttons. Fix a bug where electronic dice animations were not showing.</li>
                        <li><b>Universal Banking & Visual Polish:</b> Allow any player to bank the pot at any time, not just on their turn, via a new pop-up menu. Refine the active player highlight with a more subtle, animated gradient. Fix a bug that prevented the game from starting until players were modified.</li>
                        <li><b>Final Polish & Feature Requests:</b> Add a "How was this built?" section. Add a "Rules" button to the start-game screen. Implement a two-step confirmation for deleting players. Redesign main action buttons with new icons and styles. Refine spacing and alignment in the control panel.</li>
                        <li><b>Final Bug Fixes & Style Refinements:</b> Fix bugs related to the new modal pop-ups. Relocate the game title to the start-game screen. Further refine the "Atoms" button layout and player highlight effect.</li>
                        <li><b>Padding & Highlight Refinement:</b> Reduce padding in control panel. Change active player highlight from scaling to a gradient border effect.</li>
                        <li><b>Bug Fix & Feature Polish (Current):</b> Fix banking bug where pot incorrectly reset to zero. Enhance confetti for bonus rolls and doubles. Overhaul "How it was built" modal with new text and a detailed development log.</li>
                    </ol>
                </div>
            </div>
            <div class="flex-shrink-0 flex gap-3 mt-6">
                <button data-action="close-how-built" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Awesome!</button>
            </div>
        </div>
    </div>
    <div id="red-flash" style="display: none;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const doc = document;
            const playersContainer = doc.getElementById('players-container');
            const diceContainer1 = doc.getElementById('dice-container-1');
            const diceContainer2 = doc.getElementById('dice-container-2');
            const modalBackdrop = doc.getElementById('modal-backdrop');
            const winnerModalContent = doc.getElementById('winner-modal-content');
            const editNameModalContent = doc.getElementById('edit-name-modal-content');
            const roundsModalContent = doc.getElementById('rounds-modal-content');
            const bankingModalContent = doc.getElementById('banking-modal-content');
            const newGameConfirmModal = doc.getElementById('new-game-confirm-modal');
            const rulesModalContent = doc.getElementById('rules-modal-content');
            const howBuiltModal = doc.getElementById('how-built-modal');
            const bankingPlayerList = doc.getElementById('banking-player-list');
            const winnerMessage = doc.getElementById('winner-message');
            const editNameInput = doc.getElementById('edit-name-input');
            const roundsInput = doc.getElementById('rounds-input');
            const centralBankScoreEl = doc.getElementById('central-bank-score');
            const roundCounterEl = doc.getElementById('round-counter');
            const bonusRollsCounterEl = doc.getElementById('bonus-rolls-counter');
            
            let players = [];
            let activePlayerIndex = 0;
            let isGameOver = false;
            let playerToEditId = null;
            let totalRounds = 10;
            let currentRound = 0;
            let centralBankScore = 0;
            let gameMode = 'electronic';
            let rollCountInRound = 0;
            let isBusting = false;
            let history = [];
            let deleteConfirmId = null;

            const diceSVGs = {
                1: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="8" cy="8" r="1.5" fill="currentColor"/></svg>`,2: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="4.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="11.5" r="1.5" fill="currentColor"/></svg>`,3: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="4.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="11.5" cy="11.5" r="1.5" fill="currentColor"/></svg>`,4: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="4.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="4.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="11.5" r="1.5" fill="currentColor"/></svg>`,5: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="4.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="4.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="11.5" r="1.5" fill="currentColor"/></svg>`,6: `<svg class="w-full h-full text-slate-700" viewBox="0 0 16 16"><circle cx="4.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="4.5" r="1.5" fill="currentColor"/><circle cx="4.5" cy="8" r="1.5" fill="currentColor"/><circle cx="11.5" cy="8" r="1.5" fill="currentColor"/><circle cx="4.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="11.5" cy="11.5" r="1.5" fill="currentColor"/></svg>`,
            };
            const dicePlaceholder = `<div class="w-full h-full text-slate-400 border-4 border-dashed rounded-2xl"></div>`;
            
            const showModal = (modalContent) => {
                modalBackdrop.classList.remove('hidden');
                modalBackdrop.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden'));
                modalContent.classList.remove('hidden');
                setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50);
            };

            const hideModals = () => {
                modalBackdrop.querySelectorAll('.modal-content').forEach(m => m.classList.add('scale-95', 'opacity-0'));
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden'));
                }, 200);
            };

            const initGame = () => {
                isGameOver = true;
                showModal(roundsModalContent);
            };

            const startGame = () => {
                totalRounds = parseInt(roundsInput.value) || 10;
                players = [];
                currentRound = 0;
                history = [];
                hideModals();
                addPlayer();
                addPlayer();
                startNewRound();
                isGameOver = false;
                doc.querySelector('[data-action="add-player"]').disabled = false;
                updateUI();
            };
            
            const startNewRound = () => {
                isBusting = false;
                currentRound++;
                if (currentRound > totalRounds) {
                    endGame();
                    return;
                }
                centralBankScore = 0;
                rollCountInRound = 0;
                history = [];
                players.forEach(p => p.hasBanked = false);
                activePlayerIndex = players.length > 0 ? (currentRound - 1) % players.length : 0;
                diceContainer1.innerHTML = dicePlaceholder;
                diceContainer2.innerHTML = dicePlaceholder;
                updateUI();
            };

            const addPlayer = () => {
                if (players.length >= 10) return;
                players.push({ name: `Player ${players.length + 1}`, totalScore: 0, id: Date.now(), hasBanked: false });
                updateUI();
            };

            const removePlayer = (id) => {
                if (players.length <= 2) return;
                const indexToRemove = players.findIndex(p => p.id === id);
                if (indexToRemove === -1) return;
                const wasActive = indexToRemove === activePlayerIndex;
                
                players.splice(indexToRemove, 1);
                
                if (activePlayerIndex >= indexToRemove && activePlayerIndex > 0) {
                    activePlayerIndex--;
                } else if (activePlayerIndex >= players.length) {
                    activePlayerIndex = 0;
                }

                if (wasActive || players.every(p => p.hasBanked)) {
                    activePlayerIndex = getNextPlayerIndex();
                }

                doc.querySelector('[data-action="add-player"]').disabled = false;
                updateUI();
            };

            const getNextPlayerIndex = () => {
                if (players.length === 0 || players.every(p => p.hasBanked)) return activePlayerIndex;
                let nextIndex = activePlayerIndex;
                let attempts = 0;
                do {
                    nextIndex = (nextIndex + 1) % players.length;
                    attempts++;
                } while (players[nextIndex].hasBanked && attempts < players.length * 2);
                return nextIndex;
            };
            
            const saveState = () => {
                history.push({
                    centralBankScore,
                    rollCountInRound,
                    activePlayerIndex,
                    players: JSON.parse(JSON.stringify(players))
                });
            };

            const undoLastRoll = () => {
                if (history.length === 0) return;
                const lastState = history.pop();
                centralBankScore = lastState.centralBankScore;
                rollCountInRound = lastState.rollCountInRound;
                activePlayerIndex = lastState.activePlayerIndex;
                players = lastState.players;
                updateUI();
            };

            const processRoll = (sum) => {
                if(isGameOver || isBusting) return;
                
                saveState();
                rollCountInRound++;

                if (rollCountInRound <= 3 && sum === 7) {
                    centralBankScore += 70;
                    const bustBtn = doc.querySelector('[data-sum="7"]');
                    triggerConfetti({ count: 100, origin: bustBtn });
                } else if (sum === 7) {
                    isBusting = true;
                    triggerRedFlash();
                    setTimeout(startNewRound, 1200);
                } else {
                    centralBankScore += sum;
                }
                activePlayerIndex = getNextPlayerIndex();
                updateUI();
            };

            const openBankModal = () => {
                if (isGameOver || centralBankScore === 0) return;
                bankingPlayerList.innerHTML = '';
                const unbankedPlayers = players.filter(p => !p.hasBanked);
                unbankedPlayers.forEach(player => {
                    const label = doc.createElement('label');
                    label.className = 'flex items-center p-3 bg-slate-100 rounded-lg cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" data-player-id="${player.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 font-medium text-slate-700">${player.name}</span>
                    `;
                    bankingPlayerList.appendChild(label);
                });
                if (unbankedPlayers.length === 1) {
                    bankingPlayerList.querySelector('input').checked = true;
                }
                showModal(bankingModalContent);
            };

            const executeBank = () => {
                const checkedPlayers = doc.querySelectorAll('#banking-player-list input:checked');
                if (checkedPlayers.length === 0) {
                    hideModals();
                    return;
                }

                saveState();
                let activePlayerBanked = false;
                const pointsToAdd = Math.floor(centralBankScore / checkedPlayers.length);

                checkedPlayers.forEach(checkbox => {
                    const playerId = Number(checkbox.dataset.playerId);
                    const player = players.find(p => p.id === playerId);
                    if (player) {
                        if (players.indexOf(player) === activePlayerIndex) {
                            activePlayerBanked = true;
                        }
                        player.totalScore += pointsToAdd;
                        player.hasBanked = true;
                    }
                });
                
                centralBankScore = 0; 
                hideModals();
                
                const allBanked = players.every(p => p.hasBanked);
                if (allBanked) {
                    setTimeout(startNewRound, 1000);
                } else {
                    if (activePlayerBanked) {
                        activePlayerIndex = getNextPlayerIndex();
                    }
                }
                updateUI();
            };
            
            const endGame = () => {
                isGameOver = true;
                if (players.length > 0) {
                    const sortedPlayers = [...players].sort((a, b) => b.totalScore - a.totalScore);
                    let winner = sortedPlayers[0];
                    winnerMessage.textContent = `${winner.name} wins with ${winner.totalScore} points!`;

                    const finalScoresList = doc.getElementById('final-scores-list');
                    let scoresHTML = '<h3 class="text-lg font-bold text-slate-700 mb-2">Final Scores</h3><ul class="space-y-1">';
                    sortedPlayers.forEach((p, index) => {
                        scoresHTML += `<li class="flex justify-between p-2 rounded ${index === 0 ? 'bg-yellow-100' : 'bg-slate-50'}"><span class="font-semibold">${p.name}</span><span>${p.totalScore}</span></li>`;
                    });
                    scoresHTML += '</ul>';
                    finalScoresList.innerHTML = scoresHTML;

                } else {
                    winnerMessage.textContent = 'Game over!';
                }
                showModal(winnerModalContent);
                updateUI();
            };

            const updateUI = () => {
                roundCounterEl.textContent = `Round ${currentRound} / ${totalRounds}`;
                centralBankScoreEl.textContent = centralBankScore;
                
                if (rollCountInRound < 3 && !isGameOver && currentRound > 0) {
                    bonusRollsCounterEl.textContent = `Bonus Rolls Left: ${3 - rollCountInRound}`;
                    bonusRollsCounterEl.classList.remove('hidden');
                } else {
                    bonusRollsCounterEl.classList.add('hidden');
                }

                playersContainer.innerHTML = '';
                players.forEach((player, index) => {
                    const playerEl = doc.createElement('div');
                    playerEl.className = 'player-panel bg-white p-2 rounded-lg shadow-md transition-all duration-300 flex flex-col';
                    playerEl.dataset.id = player.id;
                    
                    const isConfirmingDelete = deleteConfirmId === player.id;

                    playerEl.innerHTML = `
                        <div class="flex justify-between items-start gap-1">
                            <div class="flex-grow min-w-0">
                                <h2 class="player-name text-sm font-bold text-slate-600 truncate">${player.name}</h2>
                                <p class="total-score text-2xl font-bold text-slate-800">${player.totalScore}</p>
                            </div>
                            <div class="player-controls flex flex-col gap-1">
                                <button data-action="edit-player" class="text-slate-400 hover:text-indigo-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                                <button data-action="remove-player" class="${isConfirmingDelete ? 'text-red-500' : 'text-slate-400'} hover:text-red-600 p-1" ${players.length <= 2 ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            </div>
                        </div>
                    `;
                    
                    playerEl.classList.toggle('player-banked', player.hasBanked);
                    playerEl.classList.toggle('player-active', index === activePlayerIndex && !isGameOver && !player.hasBanked);
                    if (isGameOver && players.length > 0) {
                        const maxScore = Math.max(...players.map(p => p.totalScore));
                        if (player.totalScore === maxScore && maxScore > 0) {
                             playerEl.classList.add('player-winner');
                        }
                    }
                    
                    playersContainer.appendChild(playerEl);
                });

                const currentPlayer = players[activePlayerIndex];
                const activePlayerIsBanked = !currentPlayer || currentPlayer.hasBanked;
                const rollControlsDisabled = isGameOver || activePlayerIsBanked || isBusting;
                const bankControlDisabled = isGameOver || centralBankScore === 0 || players.every(p => p.hasBanked) || isBusting;

                doc.querySelector('[data-action="roll-dice"]').disabled = rollControlsDisabled;
                doc.querySelectorAll('[data-action="submit-atom-roll"]').forEach(btn => btn.disabled = rollControlsDisabled);
                doc.querySelector('[data-action="bank-score"]').disabled = bankControlDisabled;
                
                const undoBtn = doc.querySelector('[data-action="undo"]');
                if (undoBtn) undoBtn.disabled = history.length === 0 || isBusting;
                
                const doublesBtn = doc.querySelector('[data-action="apply-doubles"]');
                if (doublesBtn) doublesBtn.disabled = rollControlsDisabled || centralBankScore === 0;

                const bustBtn = doc.querySelector('[data-sum="7"]');
                if (bustBtn) {
                    const bustBonusClasses = 'bg-green-200 text-green-700 border-green-400';
                    const bustRegularClasses = 'bg-red-200 text-red-700 border-red-400';
                    bustBtn.classList.remove(...bustBonusClasses.split(' '), ...bustRegularClasses.split(' '));
                    bustBtn.classList.add(...(rollCountInRound < 3 ? bustBonusClasses : bustRegularClasses).split(' '));
                }
            };

            const generateAtomButtons = () => {
                const grid = doc.getElementById('atom-buttons-grid');
                grid.innerHTML = '';

                const buttons = [
                    { sum: 2 }, { sum: 3 }, { sum: 4 }, { sum: 5 },
                    { sum: 6 }, { sum: 7 }, { sum: 8 }, { sum: 9 },
                    { sum: 10 }, { sum: 11 }, { sum: 12 },
                    { sum: 'doubles' }
                ];

                buttons.forEach(({ sum }) => {
                    const btn = doc.createElement('button');
                    let text, action, classes;
                    
                    if (sum === 'doubles') {
                        text = 'x2';
                        action = 'apply-doubles';
                        classes = 'bg-sky-100 text-sky-700 border-sky-300';
                    } else {
                        text = sum;
                        action = 'submit-atom-roll';
                        classes = 'bg-white text-slate-700 border-slate-300';
                        btn.dataset.sum = sum;
                    }
                    
                    btn.dataset.action = action;
                    btn.className = `rounded-md py-1 font-bold border active:scale-95 text-center flex items-center justify-center ${classes}`;
                    btn.innerHTML = text;
                    grid.appendChild(btn);
                });
            };

            const triggerConfetti = ({ count = 30, size = 8, origin = doc.body } = {}) => {
                const rect = origin.getBoundingClientRect();
                const originX = rect.left + rect.width / 2;
                const originY = rect.top + rect.height / 2;

                for (let i = 0; i < count; i++) {
                    const confetti = doc.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size}px`;
                    confetti.style.left = `${originX}px`;
                    confetti.style.top = `${originY}px`;
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    confetti.style.pointerEvents = 'none';
                    confetti.style.zIndex = '10000';
                    doc.body.appendChild(confetti);

                    const angle = Math.random() * 2 * Math.PI;
                    const blastRadius = Math.random() * 100 + 150;
                    const endX = Math.cos(angle) * blastRadius;
                    const endY = Math.sin(angle) * blastRadius + 50;
                    const rotation = Math.random() * 720 - 360;

                    confetti.animate([
                        { transform: 'translate(-50%, -50%) rotate(0deg) scale(1)', opacity: 1 },
                        { transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) rotate(${rotation}deg) scale(0)`, opacity: 0 }
                    ], {
                        duration: 1200 + Math.random() * 800,
                        easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)',
                        delay: Math.random() * 100,
                        fill: 'forwards'
                    });

                    setTimeout(() => confetti.remove(), 2000);
                }
            };

            const triggerRedFlash = () => {
                const flash = doc.getElementById('red-flash');
                flash.style.display = 'block';
                void flash.offsetWidth;
                flash.style.animation = 'red-flash-anim 0.3s ease-out';
                setTimeout(() => {
                    flash.style.animation = 'none';
                    flash.style.display = 'none';
                }, 300);
            };

            doc.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target || target.disabled) return;
                const action = target.dataset.action;

                const isDeleteButton = action === 'remove-player';
                if (!isDeleteButton && deleteConfirmId !== null) {
                    deleteConfirmId = null;
                    updateUI();
                }

                switch (action) {
                    case 'new-game': showModal(newGameConfirmModal); break;
                    case 'confirm-new-game': initGame(); break;
                    case 'start-game': startGame(); break;
                    case 'play-again': initGame(); break;
                    case 'add-player': addPlayer(); break;
                    case 'cancel-modal': hideModals(); break;
                    case 'bank-score': openBankModal(); break;
                    case 'confirm-bank': executeBank(); break;
                    case 'undo': undoLastRoll(); break;
                    case 'show-rules': showModal(rulesModalContent); break;
                    case 'close-rules': showModal(roundsModalContent); break;
                    case 'how-built': showModal(howBuiltModal); break;
                    case 'close-how-built': showModal(roundsModalContent); break;
                    case 'roll-dice': {
                        const dice1 = Math.floor(Math.random() * 6) + 1;
                        const dice2 = Math.floor(Math.random() * 6) + 1;
                        diceContainer1.innerHTML = diceSVGs[dice1];
                        diceContainer2.innerHTML = diceSVGs[dice2];
                        if(diceContainer1.firstChild) diceContainer1.firstChild.classList.add('dice-animation');
                        if(diceContainer2.firstChild) diceContainer2.firstChild.classList.add('dice-animation');
                        
                        if (dice1 === dice2) {
                            processRoll(dice1 + dice2);
                            if (centralBankScore > 0) {
                                saveState();
                                centralBankScore *= 2;
                                let confettiCount = 1;
                                let confettiSize = 10;
                                if (centralBankScore > 1000) { confettiCount = 50; confettiSize = 20; }
                                else if (centralBankScore > 600) { confettiCount = 35; confettiSize = 18; }
                                else if (centralBankScore > 400) { confettiCount = 25; confettiSize = 16; }
                                else if (centralBankScore > 200) { confettiCount = 15; confettiSize = 14; }
                                else if (centralBankScore > 50) { confettiCount = 10; confettiSize = 12; }
                                triggerConfetti({ count: confettiCount, size: confettiSize, origin: centralBankScoreEl });
                                updateUI();
                            }
                        } else {
                            processRoll(dice1 + dice2);
                        }
                        break;
                    }
                    case 'submit-atom-roll': {
                        const sum = parseInt(target.dataset.sum);
                        processRoll(sum);
                        break;
                    }
                    case 'apply-doubles': {
                        if (centralBankScore > 0) {
                            saveState();
                            rollCountInRound++; 
                            centralBankScore *= 2;
                            let confettiCount = 1;
                            let confettiSize = 10;
                            if (centralBankScore > 1000) { confettiCount = 50; confettiSize = 20; }
                            else if (centralBankScore > 600) { confettiCount = 35; confettiSize = 18; }
                            else if (centralBankScore > 400) { confettiCount = 25; confettiSize = 16; }
                            else if (centralBankScore > 200) { confettiCount = 15; confettiSize = 14; }
                            else if (centralBankScore > 50) { confettiCount = 10; confettiSize = 12; }
                            triggerConfetti({ count: confettiCount, size: confettiSize, origin: centralBankScoreEl });
                            updateUI();
                        }
                        break;
                    }
                    case 'save-name': {
                        const newName = editNameInput.value.trim();
                        if (newName && playerToEditId) {
                            const player = players.find(p => p.id === playerToEditId);
                            if (player) player.name = newName;
                            hideModals();
                            updateUI();
                        }
                        break;
                    }
                    case 'edit-player': {
                        playerToEditId = Number(e.target.closest('.player-panel').dataset.id);
                        const player = players.find(p => p.id === playerToEditId);
                        if (player) {
                            editNameInput.value = player.name;
                            showModal(editNameModalContent);
                            editNameInput.focus();
                        }
                        break;
                    }
                    case 'remove-player': {
                        const id = Number(e.target.closest('.player-panel').dataset.id);
                        if (deleteConfirmId === id) {
                            removePlayer(id);
                            deleteConfirmId = null;
                        } else {
                            deleteConfirmId = id;
                            updateUI();
                        }
                        break;
                    }
                }
            });
            
            howBuiltModal.addEventListener('click', (e) => {
                const target = e.target.closest('[data-tab-target]');
                if (!target) return;

                const tabTarget = target.dataset.tabTarget;
                howBuiltModal.querySelectorAll('.how-built-tab').forEach(tab => {
                    tab.classList.toggle('how-built-tab-active', tab.dataset.tabTarget === tabTarget);
                    tab.classList.toggle('text-slate-700', tab.dataset.tabTarget === tabTarget);
                    tab.classList.toggle('text-slate-500', tab.dataset.tabTarget !== tabTarget);
                });
                howBuiltModal.querySelectorAll('.how-built-tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== tabTarget);
                });
            });

            doc.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    gameMode = tab.dataset.tab;
                    doc.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    if (gameMode === 'electronic') {
                        doc.getElementById('electronic-controls').classList.remove('hidden');
                        doc.getElementById('atom-controls').classList.add('hidden');
                    } else {
                        doc.getElementById('electronic-controls').classList.add('hidden');
                        doc.getElementById('atom-controls').classList.remove('hidden');
                    }
                });
            });

            generateAtomButtons();
            initGame();
        });
    </script>
</body>
</html>
